<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ - Ù…ÙˆØ¸ÙÙŠÙ†</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
    --bg:#f6f8fb; --panel:#fff; --border:#d7dce2;
    --acc:#0078ff; --ok:#00a676; --danger:#d9534f;
    --text:#222; --secondary:#6c757d; --secondary-hover:#5a6268;
}

*{box-sizing:border-box;font-family:"Cairo",sans-serif;}
body{margin:0;background:var(--bg);color:var(--text);}

header{
    background:var(--panel);
    border-bottom:1px solid var(--border);
    padding:1rem;
    text-align:center;
    font-weight:600;
    font-size:1.2rem;
    position:sticky;
    top:0;
}

.container{max-width:1200px;margin:1rem auto;padding:1rem;}
.grid{display:grid;gap:1rem;}
@media(min-width:900px){.grid{grid-template-columns:1.1fr 1fr;}}

.card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:10px;
    padding:1rem;
    box-shadow:0 2px 4px rgba(0,0,0,.05);
}

h2{
    margin-top:0;
    font-size:1.1rem;
    border-bottom:1px solid var(--border);
    padding-bottom:.4rem;
}

.flex{display:flex;gap:.5rem;flex-wrap:wrap;}

input,button,select{
    font:inherit;
    padding:.5rem .7rem;
    border-radius:6px;
    border:1px solid var(--border);
}

button{cursor:pointer;}

.btn-primary{background:var(--acc);color:#fff;border:none;}
.btn-ok{background:var(--ok);color:#fff;border:none;}
.btn-danger{background:var(--danger);color:#fff;border:none;}
.btn-secondary{background:var(--secondary);color:#fff;border:none;}
.btn-secondary:hover{background:var(--secondary-hover);}

table{width:100%;border-collapse:collapse;margin-top:.5rem;}
th,td{
    padding:.5rem;border-bottom:1px solid var(--border);text-align:center;
}
th{background:#f0f3f8;}

.status{
    padding:.6rem;border-radius:8px;
    background:#eef3f8;margin-top:.5rem;
}
.status.ok{border:1px solid var(--ok);color:var(--ok);}
.status.err{border:1px solid var(--danger);color:var(--danger);}

.keypad{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:.4rem;
    margin-top:.5rem;
}
.keypad button{
    background:#f3f5f9;
    border:1px solid var(--border);
}

.section{
    margin-top:1rem;
    border-top:1px dashed var(--border);
    padding-top:1rem;
}

.small{font-size:.9rem;color:#555;}

.qrCell{display:flex;flex-direction:column;align-items:center;}

.hidden {
    display: none;
}

.tabs {
    display: flex;
    background-color: #f0f3f8;
    border-bottom: 1px solid var(--border);
}

.tab {
    padding: 1rem;
    cursor: pointer;
    flex: 1;
    text-align: center;
    font-weight: 600;
    border-left: 1px solid var(--border);
}

.tab:first-child {
    border-left: none;
}

.tab.active {
    background-color: var(--panel);
    border-bottom: 2px solid var(--acc);
}

/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø¥ÙŠØµØ§Ù„ */
#printReceipt { display: none; background: #fff; padding: 20px; direction: rtl; font-family: 'Cairo', sans-serif; color: #000; }
#printReceipt h2 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
#printReceipt table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
#printReceipt th, #printReceipt td { border: 1px solid #000; padding: 5px; text-align: center; }
#printReceipt .summary { text-align: right; margin-top: 20px; font-size: 14px; line-height: 1.6; }
#printReceipt .footer { margin-top: 50px; display: flex; justify-content: space-between; font-size: 12px; }

@media print {
    body > * { display: none !important; }
    #printReceipt { display: block !important; width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
    @page { size: A5; margin: 0; }
}
</style>
</head>

<body>

<header>ğŸ“… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</header>

<div class="tabs">
    <div class="tab active" onclick="showPage('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬</div>
    <div class="tab" onclick="showPage('employees')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
    <div class="tab" onclick="showPage('dashboard')">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
</div>

<div id="login" class="page">
    <div class="container grid">
        <!-- ØªØ³Ø¬ÙŠÙ„ -->
        <section class="card">
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ / Ø®Ø±ÙˆØ¬</h2>
            <p class="small">ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ 4 Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠÙ‹Ø§</p>

            <label>Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:</label>
            <select id="manualDay" style="width:100%; margin-bottom:10px;">
                <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
                <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
                <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
                <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
                <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
                <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
            </select>

            <div class="flex">
                <input type="text" id="scanInput" inputmode="numeric" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
                <button class="btn-primary" id="btnRegister">ØªØ³Ø¬ÙŠÙ„</button>
                <button id="btnFocus">ØªÙ†Ø´ÙŠØ·</button>
            </div>

            <div class="keypad">
                <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
                <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
                <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
                <button data-k="del">Ù…Ø³Ø­</button><button data-k="0">0</button><button data-k="ok">Ø¥Ø¯Ø®Ø§Ù„</button>
            </div>

            <div class="section">
                <h3>Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø¯ÙˆØ§Ù…</h3>
                <div class="flex">
                    <select id="manualEmpSelect"></select>
                    <select id="manualSessionSelect">
                        <option value="1">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
                        <option value="2">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
                    </select>
                    <input type="time" id="manualInTime" placeholder="ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„">
                    <input type="time" id="manualOutTime" placeholder="ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬">
                    <button class="btn-secondary" id="btnManualEntry">Ø­ÙØ¸ ÙŠØ¯ÙˆÙŠ</button>
                </div>
                <p class="small">Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù„ÙˆØ¶Ø¹ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ØªØ¹Ø·Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯.</p>
            </div>

            <div id="statusBox" class="status">Ø¬Ø§Ù‡Ø²...</div>
        </section>
    </div>
</div>

<div id="employees" class="page hidden">
    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
    <div class="container grid">
        <section class="card">
            <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
            <div class="flex">
                <input type="text" id="empName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
                <input type="number" id="empSalary" placeholder="Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (USD)">
                <button class="btn-ok" id="btnAdd">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
            </div>

            <table id="empTable">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø±Ø§ØªØ¨</th><th>QR</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>
    </div>
</div>

<div id="dashboard" class="page hidden">
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="container card">
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>

        <div class="flex">
            <select id="empSelect"></select>
            <input type="number" id="withdrawAmt" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø­Ø¨ ($)">
            <button class="btn-danger" id="btnWithdraw">Ø¥Ø¶Ø§ÙØ© Ø³Ø­Ø¨</button>
            <button id="btnLunchBreak" class="btn-danger">ğŸšª Ø®Ø±ÙˆØ¬ Ø¬Ù…Ø§Ø¹ÙŠ (1)</button>
            <button id="btnReset">ğŸ”„ ØªØµÙÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
            <button id="btnPrint" class="btn-primary">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© A5</button>
        </div>

        <hr>

        <div class="section">
            <h3>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ§Ù…</h3>
            <table id="attendanceTable">
                <thead>
                <tr>
                    <th>Ø§Ù„ÙŠÙˆÙ…</th>
                    <th>Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                    <th>Ø§Ù„Ø®Ø±ÙˆØ¬</th>
                    <th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                    <th>Ø§Ù„Ø£Ø¬Ø±</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="section">
            <h3>Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
            <p id="summaryText">â€”</p>
            <button id="btnPdf" class="btn-primary">ğŸ“„ PDF</button>
        </div>

        <div class="section">
            <h3>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
            <button id="btnExportExcel" class="btn-primary">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>

            <table id="allEmpTable">
                <thead>
                <tr>
                    <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    <th>Ø§Ù„Ø³Ø¨Øª</th>
                    <th>Ø§Ù„Ø£Ø­Ø¯</th>
                    <th>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</th>
                    <th>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</th>
                    <th>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</th>
                    <th>Ø§Ù„Ø®Ù…ÙŠØ³</th>
                    <th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                    <th>Ø§Ù„Ù…Ø³ØªØ­Ù‚</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="printReceipt"></div>

<script>
function showPage(pageId) {
    // Hide all pages
    document.querySelectorAll('.page').forEach(page => {
        page.classList.add('hidden');
    });

    // Deactivate all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Show the selected page
    document.getElementById(pageId).classList.remove('hidden');

    // Activate the selected tab
    document.querySelector(`.tab[onclick="showPage('${pageId}')"]`).classList.add('active');
}
/* ------------------ Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø§Ù„Ø«Ø§Ø¨ØªÙˆÙ† ------------------- */
const FIXED = {
 "101001": {name:"Ø³ÙŠØ¹Ø¯ Ø¹Ù†Ø¯Ø§Ù†ÙŠ", salaryUSD:75},
 "101002": {name:"Ø£Ø­Ù…Ø¯ Ù…ÙŠØ±Ø´", salaryUSD:66},
 "101003": {name:"Ø¬Ù…Ø§Ù„ Ø¹Ø¬Ø§Ù† Ø­Ø¯ÙŠØ¯", salaryUSD:66},
 "101004": {name:"Ø¹Ø¨Ø¯ Ø§Ù„ÙˆÙ‡Ø§Ø¨", salaryUSD:55},
 "101005": {name:"Ù…Ø­Ù…ÙˆØ¯ Ø­Ù…Ø§Ø¯ÙŠ", salaryUSD:66},
 "101006": {name:"Ø´Ø¹Ø¨Ø§Ù† Ù…ØµØ±ÙŠ", salaryUSD:30},
 "101007": {name:"Ø£Ø¨Ùˆ Ø¥ÙŠÙ‡Ù…", salaryUSD:55},
 "101008": {name:"ÙˆØ§Ø¦Ù„ Ø¨ÙƒØ¯Ø§Ø´", salaryUSD:45},
 "101009": {name:"Ø£Ø¨Ùˆ ÙƒØ§Ø³Ù…", salaryUSD:60},
 "101010": {name:"Ø¹Ù…Ø± Ù…ØµØ±ÙŠ", salaryUSD:55},
 "101011": {name:"Ù…ØµØ·ÙÙ‰ Ø³ÙØ±Ø§Ù†ÙŠ", salaryUSD:66},
 "101012": {name:"Ø¹Ø¯Ù†Ø§Ù† Ù…ÙŠØ±Ø´", salaryUSD:45},
 "101013": {name:"Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ù†Ø§Ù†", salaryUSD:30},
 "101014": {name:"Ø­Ø³ÙŠÙ†", salaryUSD:30},
 "101015": {name:"Ø£Ø­Ù…Ø¯ Ø­Ø¬ Ø®Ù„Ù", salaryUSD:30},
 "101016": {name:"Ø´ÙˆØ§Ø®", salaryUSD:45},
 "101017": {name:"Ø¹Ù…Ø± ÙˆØ¯ÙŠØ¹Ø©", salaryUSD:55},
 "101018": {name:"Ø¹Ø¨Ø¯ Ø§Ù„ÙØªØ§Ø­", salaryUSD:28},
 "101019": {name:"Ù…ØµØ·ÙÙ‰ Ø­Ù…Ø§Ø¯ÙŠ", salaryUSD:30},
 "101020": {name:"Ø¹Ø¨Ø¯ Ø§Ù„ØºÙ†ÙŠ Ù†Ø¬Ø§Ø±", salaryUSD:45},
 "101021": {name:"Ø£Ù… Ø¹Ø¯Ù†Ø§Ù†", salaryUSD:30},
 "101022": {name:"ØºØ§Ø¯Ø©", salaryUSD:30},
 "101023": {name:"ÙˆÙØ§Ø¡", salaryUSD:30},
 "101024": {name:"Ø­Ø³ÙŠÙ† Ø§Ù„Ø¬Ø¨Ù„ÙŠ", salaryUSD:55}
};

let data = JSON.parse(localStorage.getItem("attData") || "{}");

if (!data.emps) {
    data = { emps: FIXED, logs:{}, withdraws:{} };
    localStorage.setItem("attData", JSON.stringify(data));
}

const days=["Ø§Ù„Ø³Ø¨Øª","Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³"];
const MIN_LOGOUT_MINUTES=15;

function saveData(){localStorage.setItem("attData",JSON.stringify(data));}

const scanInput = document.querySelector("#login #scanInput");
const statusBox = document.querySelector("#login #statusBox");
const empSelect = document.querySelector("#dashboard #empSelect");
const manualEmpSelect=document.querySelector("#login #manualEmpSelect");
const manualSessionSelect=document.querySelector("#login #manualSessionSelect");
const manualInTime=document.querySelector("#login #manualInTime");
const manualOutTime=document.querySelector("#login #manualOutTime");
const summaryText = document.querySelector("#dashboard #summaryText");

function setStatus(msg,t=""){statusBox.textContent=msg; statusBox.className="status "+t;}

function randId(){
    let id;
    do{id=Math.floor(200000+Math.random()*900000).toString();}
    while(data.emps[id]);
    return id;
}

/* ------------------ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ------------------- */
function refreshEmpTable(){
    const tb=document.querySelector("#empTable tbody");
    tb.innerHTML=""; 
    const old=empSelect.value; 
    empSelect.innerHTML="";
    const manualOld=manualEmpSelect?manualEmpSelect.value:"";
    if(manualEmpSelect) manualEmpSelect.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>';

    Object.entries(data.emps).forEach(([id,emp])=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
            <td>${emp.name}</td>
            <td>${id}</td>
            <td>${emp.salaryUSD}</td>
            <td class="qrCell" id="qr${id}"></td>
            <td><button class="btn-danger" onclick="delEmp('${id}')">Ø­Ø°Ù</button></td>
        `;
        tb.appendChild(tr);

        const div=document.createElement("div");
        document.getElementById("qr"+id).appendChild(div);
        new QRCode(div,{text:id,width:60,height:60});

        const btn=document.createElement("button");
        btn.textContent="ØªØ­Ù…ÙŠÙ„";
        btn.className="btn-primary small";
        btn.onclick=()=>{const c=div.querySelector("canvas"); const a=document.createElement("a"); a.href=c.toDataURL(); a.download=emp.name+".png"; a.click();}
        document.getElementById("qr"+id).appendChild(btn);

        const opt=document.createElement("option");
        opt.value=id; 
        opt.textContent=`${emp.name} (${id})`; 
        empSelect.appendChild(opt);

        if(manualEmpSelect){
            const mOpt=document.createElement("option");
            mOpt.value=id;
            mOpt.textContent=`${emp.name} (${id})`;
            manualEmpSelect.appendChild(mOpt);
        }
    });

    if(data.emps[old]) empSelect.value=old;
    if(manualEmpSelect&&manualOld&&data.emps[manualOld]) manualEmpSelect.value=manualOld;

    updateAttendanceTable();
}

/* ------------------ Ø­Ø°Ù Ù…ÙˆØ¸Ù ------------------- */
/* ------------------ Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± ------------------- */

// Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙŠÙˆÙ… ÙŠØªÙ… Ø­ÙØ¸Ù‡
document.getElementById("manualDay").addEventListener("change", () => {
    localStorage.setItem("selectedDay", document.getElementById("manualDay").value);
});

// Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© ÙŠØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚
const savedDay = localStorage.getItem("selectedDay");
if (savedDay) {
    document.getElementById("manualDay").value = savedDay;
}

function delEmp(id){
    delete data.emps[id];
    saveData(); 
    refreshAllTables();
}

/* ------------------ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù ------------------- */
document.getElementById("btnAdd").addEventListener('click', () => {
    const n = document.getElementById('empName').value.trim();
    const s = Number(document.getElementById('empSalary').value);
    if (!n || !s) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        return;
    }
    const id = randId();
    data.emps[id] = {
        name: n,
        salaryUSD: s
    };
    saveData();
    refreshAllTables();
    document.getElementById('empName').value = "";
    document.getElementById('empSalary').value = "";
});

/* ------------------ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ ------------------- */
let lastScanTimes={};

function handleScan(id){
    const emp=data.emps[id];
    if(!emp){setStatus("âŒ Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","err"); return;}
    if(Date.now()-(lastScanTimes[id]||0)<3000){setStatus("â³ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„","err"); return;}
    lastScanTimes[id]=Date.now();

    const now=new Date();
    const time=now.toTimeString().slice(0,5);
    const day = document.getElementById("manualDay").value;

    if(!data.logs[id]) data.logs[id]={};
    const log=data.logs[id][day]||{};

    if(!log.in1){log.in1=time; setStatus(`Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„: ${emp.name}`,"ok");}
    else if(!log.out1){
        if(!canLogout(log.in1,time)){setStatus(`ÙŠØ¬Ø¨ Ù…Ø±ÙˆØ± ${MIN_LOGOUT_MINUTES} Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬`,"err"); return;}
        log.out1=time; setStatus(`Ø®Ø±ÙˆØ¬ Ø£ÙˆÙ„: ${emp.name}`,"ok");
    }
    else if(!log.in2){log.in2=time; setStatus(`Ø¯Ø®ÙˆÙ„ Ø«Ø§Ù†ÙŠ: ${emp.name}`,"ok");}
    else if(!log.out2){
        if(!canLogout(log.in2,time)){setStatus(`ÙŠØ¬Ø¨ Ù…Ø±ÙˆØ± ${MIN_LOGOUT_MINUTES} Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬`,"err"); return;}
        log.out2=time; setStatus(`Ø®Ø±ÙˆØ¬ Ù†Ù‡Ø§Ø¦ÙŠ: ${emp.name}`,"ok");
    }
    else { setStatus("Ø§Ù„ÙŠÙˆÙ… Ù…ÙƒØªÙ…Ù„","err"); return;}

    data.logs[id][day]=log;
    saveData(); refreshAllTables();
}


document.querySelector("#login #btnRegister").onclick = () => {
    if (scanInput.value.trim()) handleScan(scanInput.value.trim());
    scanInput.value = "";
};
scanInput.addEventListener("keydown", e => {
    if (e.key === "Enter") document.querySelector("#login #btnRegister").click();
});
document.querySelector("#login #btnFocus").onclick = () => scanInput.focus();
document.querySelectorAll("#login .keypad button").forEach(b => {
    b.onclick = () => {
        const k = b.dataset.k;
        if (k === "del") scanInput.value = "";
        else if (k === "ok") document.querySelector("#login #btnRegister").click();
        else scanInput.value += k;
        scanInput.focus();
    }
});

document.querySelector("#login #btnManualEntry").onclick=()=>{
    if(!manualEmpSelect)return;
    const id=manualEmpSelect.value;
    if(!id){setStatus("Ø§Ø®ØªØ± Ù…ÙˆØ¸ÙÙ‹Ø§ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„","err");return;}
    const day=document.getElementById("manualDay").value;
    const period=manualSessionSelect.value;
    const inTime=manualInTime.value;
    const outTime=manualOutTime.value;
    if(!inTime && !outTime){setStatus("Ø£Ø¯Ø®Ù„ ÙˆÙ‚ØªÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„","err");return;}

    if(!data.logs[id]) data.logs[id]={};
    const log=data.logs[id][day]||{};
    if(period==="1"){
        if(inTime) log.in1=inTime;
        if(outTime) log.out1=outTime;
    }else{
        if(inTime) log.in2=inTime;
        if(outTime) log.out2=outTime;
    }
    data.logs[id][day]=log;
    saveData();
    refreshAllTables();
    manualInTime.value="";
    manualOutTime.value="";
    setStatus("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ ÙŠØ¯ÙˆÙŠÙ‹Ø§","ok");
};

/* ------------------ Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø£Ø¬Ø± ------------------- */
function parseTime(t){const[a,b]=t.split(":");return (+a)*60+(+b);}
function diffHours(a,b){if(!a||!b)return 0; return Math.max(0,(parseTime(b)-parseTime(a))/60);}
function canLogout(inTime,outTime){if(!inTime||!outTime) return false; return parseTime(outTime)-parseTime(inTime)>=MIN_LOGOUT_MINUTES;}
function calcPay(id,day){
    const emp=data.emps[id]; const log=(data.logs[id]||{})[day]; if(!log) return 0;
    const base=emp.salaryUSD/(6*10*60); let total=0;
    [[log.in1,log.out1],[log.in2,log.out2]].forEach(([i,o])=>{
        if(!i||!o) return;
        const s=parseTime(i), e=parseTime(o);
        const extra=parseTime("18:00");
        for(let m=s;m<e;m++){total+=base*(m>=extra?2:1);}
    });
    return total;
}

/* ------------------ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ------------------- */
function updateAttendanceTable(){
    const id=empSelect.value;
    const tb=document.querySelector("#attendanceTable tbody");
    tb.innerHTML=""; if(!id) return;

    let total=0;
    days.forEach(d=>{
        const log=(data.logs[id]||{})[d]||{};
        const h=diffHours(log.in1,log.out1)+diffHours(log.in2,log.out2);
        const p=calcPay(id,d);
        total+=p;
        tb.innerHTML+=`<tr><td>${d}</td><td>${log.in1||"â€”"} / ${log.in2||"â€”"}</td><td>${log.out1||"â€”"} / ${log.out2||"â€”"}</td><td>${h.toFixed(2)}</td><td>${p.toFixed(2)}</td></tr>`;
    });

    const w=(data.withdraws[id]||[]).reduce((a,b)=>a+b,0);
    summaryText.innerHTML=`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b>${total.toFixed(2)}</b> $<br>Ø§Ù„Ø³Ø­Ø¨: <b>${w}</b>$<br>Ø§Ù„ØµØ§ÙÙŠ: <b>${(total-w).toFixed(2)}</b> $`;
}

/* ------------------ Ø¬Ø¯ÙˆÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ------------------- */
function updateAllEmpTable(){
    const tb=document.querySelector("#allEmpTable tbody");
    tb.innerHTML="";
    Object.entries(data.emps).forEach(([id,emp])=>{
        let totalH=0,totalP=0,row=`<td>${emp.name}</td>`;
        days.forEach(d=>{
            const log=(data.logs[id]||{})[d]||{};
            const h=diffHours(log.in1,log.out1)+diffHours(log.in2,log.out2);
            const p=calcPay(id,d);
            totalH+=h; totalP+=p;
            row+=`<td>${h.toFixed(2)}</td>`;
        });
        const w=(data.withdraws[id]||[]).reduce((a,b)=>a+b,0);
        row+=`<td>${totalH.toFixed(2)}</td><td>${(totalP-w).toFixed(2)}</td>`;
        tb.innerHTML+=`<tr>${row}</tr>`;
    });
}

/* ------------------ ØªØ­Ø¯ÙŠØ« Ø´Ø§Ù…Ù„ ------------------- */
function refreshAllTables(){refreshEmpTable(); updateAllEmpTable(); updateAttendanceTable();}
document.querySelector("#dashboard #empSelect").onchange = updateAttendanceTable;
document.querySelector("#dashboard #btnWithdraw").onclick = () => {
    const id = empSelect.value;
    const amt = Number(document.querySelector("#dashboard #withdrawAmt").value);
    if (!id || !amt) return;
    if (!data.withdraws[id]) data.withdraws[id] = [];
    data.withdraws[id].push(amt);
    document.querySelector("#dashboard #withdrawAmt").value = "";
    saveData();
    updateAttendanceTable();
    updateAllEmpTable();
};

document.querySelector("#dashboard #btnReset").onclick = () => {
    if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ø§Ù‹ ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ")) return;
    data.logs = {};
    data.withdraws = {};
    saveData();
    refreshAllTables();
};

function generateReceiptHTML(id) {
    const emp = data.emps[id];
    let html = `<h2>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h2>
    <p><b>Ø§Ù„Ù…ÙˆØ¸Ù:</b> ${emp.name}</p>
    <p><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${new Date().toLocaleDateString('ar-EG')}</p>
    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ÙŠÙˆÙ…</th>
                <th>Ø¯Ø®ÙˆÙ„</th>
                <th>Ø®Ø±ÙˆØ¬</th>
                <th>Ø³Ø§Ø¹Ø§Øª</th>
                <th>Ø£Ø¬Ø±</th>
            </tr>
        </thead>
        <tbody>`;
    
    let totalH = 0, totalP = 0;
    days.forEach(d => {
        const log = (data.logs[id] || {})[d] || {};
        const h = diffHours(log.in1, log.out1) + diffHours(log.in2, log.out2);
        const p = calcPay(id, d);
        totalH += h;
        totalP += p;
        html += `<tr>
            <td>${d}</td>
            <td>${log.in1 || "-"} / ${log.in2 || "-"}</td>
            <td>${log.out1 || "-"} / ${log.out2 || "-"}</td>
            <td>${h.toFixed(2)}</td>
            <td>${p.toFixed(2)}</td>
        </tr>`;
    });

    const w = (data.withdraws[id] || []).reduce((a, b) => a + b, 0);
    const net = totalP - w;

    html += `</tbody></table>
    <div class="summary">
        <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª: <b>${totalH.toFixed(2)}</b></div>
        <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚: <b>${totalP.toFixed(2)} $</b></div>
        <div>Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø§Øª: <b>${w.toFixed(2)} $</b></div>
        <div style="font-size:16px; border-top:1px solid #000; padding-top:5px; margin-top:5px;">Ø§Ù„ØµØ§ÙÙŠ Ù„Ù„Ø¯ÙØ¹: <b>${net.toFixed(2)} $</b></div>
    </div>
    <div class="footer">
        <div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸Ù: ....................</div>
        <div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±: ....................</div>
    </div>`;
    return html;
}

document.querySelector("#dashboard #btnPdf").onclick = () => {
    const id = empSelect.value;
    if (!id) return;
    
    const r = document.getElementById("printReceipt");
    r.innerHTML = generateReceiptHTML(id);
    r.style.display = "block";
    r.style.width = "148mm"; // A5 width

    html2canvas(r, {scale: 2}).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a5');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(data.emps[id].name + ".pdf");
        r.style.display = "none";
    });
};

document.querySelector("#dashboard #btnPrint").onclick = () => {
    const id = empSelect.value;
    if (!id) { alert("Ø§Ø®ØªØ± Ù…ÙˆØ¸ÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹"); return; }
    const r = document.getElementById("printReceipt");
    r.innerHTML = generateReceiptHTML(id);
    window.print();
};

document.querySelector("#dashboard #btnExportExcel").onclick = () => {
    let csv = "Ø§Ù„Ù…ÙˆØ¸Ù," + days.join(",") + " ,Ø§Ù„Ø³Ø§Ø¹Ø§Øª,Ø§Ù„Ù…Ø³ØªØ­Ù‚\n";
    Object.entries(data.emps).forEach(([id, emp]) => {
        let totalH = 0,
            totalP = 0,
            row = [emp.name];
        days.forEach(d => {
            const log = (data.logs[id] || {})[d] || {};
            const h = diffHours(log.in1, log.out1) + diffHours(log.in2, log.out2);
            const p = calcPay(id, d);
            totalH += h;
            totalP += p;
            row.push(h.toFixed(2));
        });
        const w = (data.withdraws[id] || []).reduce((a, b) => a + b, 0);
        row.push(totalH.toFixed(2), (totalP - w).toFixed(2));
        csv += row.join(",") + "\n";
    });
    const a = document.createElement("a");
    a.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
    a.download = "employees.csv";
    a.click();
};

document.querySelector("#dashboard #btnLunchBreak").onclick = () => {
    const day = document.getElementById("manualDay").value;
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¬Ù…Ø§Ø¹ÙŠ (Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø£ÙˆÙ„) Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØºØ§Ø¯Ø±ÙˆØ§ ÙÙŠ ÙŠÙˆÙ… " + day + "ØŸ")) return;

    const now = new Date();
    const time = now.toTimeString().slice(0, 5);

    Object.keys(data.emps).forEach(id => {
        if (!data.logs[id]) return;
        const log = data.logs[id][day];
        // Ø¥Ø°Ø§ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ (in1) ÙˆÙ„Ù… ÙŠØ³Ø¬Ù„ Ø®Ø±ÙˆØ¬ (out1)
        if (log && log.in1 && !log.out1) {
            log.out1 = time;
        }
    });
    saveData();
    refreshAllTables();
};

/* ------------------ Ø¨Ø¯Ø§ÙŠØ© ------------------- */
refreshAllTables();
</script>

</body>
</html>
